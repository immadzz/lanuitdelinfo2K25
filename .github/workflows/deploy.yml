name: ðŸš€ Deploy to Server

on:
  push:
    branches:
      - main  # DÃ©ploiement automatique Ã  chaque push sur la branche main

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: ðŸ§­ Checkout repository
        uses: actions/checkout@v4

      - name: ðŸš€ Deploy via SSH
        uses: appleboy/ssh-action@v0.1.10
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_KEY }}
          port: 22
          timeout: 60s
          command_timeout: 30m
          script: |
            echo "===== ðŸ“¦ DÃ‰BUT DU DÃ‰PLOIEMENT ====="

            cd /var/www

            # Si le dossier n'existe pas ou n'est pas un dÃ©pÃ´t Git, on le recrÃ©e
            if [ ! -d "lanuitdelinfo2K25/.git" ]; then
              echo "ðŸ”„ Clonage initial du dÃ©pÃ´t..."
              sudo rm -rf lanuitdelinfo2K25
              git clone https://github.com/immadzz/lanuitdelinfo2K25.git
              cd lanuitdelinfo2K25
            else
              echo "ðŸš€ Mise Ã  jour du dÃ©pÃ´t existant..."
              cd lanuitdelinfo2K25
              git fetch origin
              git reset --hard origin/main
            fi

            # Correction Git "dubious ownership"
            git config --global --add safe.directory /var/www/lanuitdelinfo2K25

            # Correction des permissions
            echo "ðŸ”§ Correction des permissions..."
            sudo chown -R www-data:www-data /var/www/lanuitdelinfo2K25

            echo "âœ… DÃ©ploiement terminÃ© avec succÃ¨s."
